<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>åŠ¨æ¼«è§’è‰²è¯†åˆ«</title>
  <link rel="icon" type="image/x-icon" href="./images/icon.png">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      min-height: 100vh;
      padding: 20px;
      color: #333;
      margin: 0;
      overflow-x: hidden;
    }
    
    #background-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      background-size: cover;
      background-position: center center;
      background-repeat: no-repeat;
      transition: opacity 0.5s ease-in-out;
      opacity: 0;
    }
    
    .container {
      position: relative;
      z-index: 1;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      overflow: visible;
      opacity: 0;
      transform: translateY(20px);
      animation: fadeInUp 0.8s forwards 0.3s;
    }
    
    @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  @keyframes imageFadeIn {
    0% {
      opacity: 0;
      transform: scale(0.8);
    }
    70% {
      opacity: 1;
      transform: scale(1.05);
    }
    100% {
      opacity: 1;
      transform: scale(1);
    }
  }
  
  /* 3Då¡ç‰‡å¼¹å‡ºå±‚æ ·å¼ */
  .popup-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10000;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease, visibility 0.3s ease;
    overflow: visible;
  }
  
  .popup-container.active {
    opacity: 1;
    visibility: visible;
  }
  
  .card-3d {
    perspective: 1500px;
    width: 70%;
    max-width: 600px;
    height: auto;
    position: relative;
    transform-style: preserve-3d;
    animation: cardPopIn 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    transition: transform 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    transform-origin: center;
    z-index: 2;
    margin-top: 50px;
  }
  
  .card-3d::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    border-radius: 20px;
    box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
    transform: translateZ(-30px);
    z-index: -1;
  }
  
  .popup-image {
      width: 100%;
      height: auto;
      display: block;
      border-radius: 20px;
      border: 5px solid white;
      box-shadow: 
        0 10px 25px rgba(0, 0, 0, 0.3),
        0 0 0 1px rgba(255, 255, 255, 0.1);
      transform: translateZ(20px);
      backface-visibility: hidden;
      position: relative;
      z-index: 3;
      object-fit: contain;
    }
  
  .reflection {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    border-radius: 20px;
    background: linear-gradient(135deg, 
      rgba(255, 255, 255, 0.1) 0%, 
      rgba(255, 255, 255, 0.3) 25%, 
      rgba(255, 255, 255, 0.6) 50%, 
      rgba(255, 255, 255, 0.1) 75%);
    pointer-events: none;
    z-index: 4;
    opacity: 0.6;
    mix-blend-mode: screen;
    transform: translateZ(0);
  }
  
  .highlight-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border-radius: 20px;
    overflow: hidden;
    pointer-events: none;
    z-index: 5;
    transform: translateZ(0);
  }
  
  .moving-highlight {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: radial-gradient(circle at var(--mouse-x, 50%) var(--mouse-y, 50%), 
      rgba(255, 255, 255, 0.4) 0%, 
      rgba(255, 255, 255, 0.1) 30%, 
      transparent 70%);
    pointer-events: none;
    opacity: 0.6;
  }
  
  .face-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 6;
    border-radius: 20px;
  }
  
  .face-bounding-box {
    position: absolute;
    border: 3px solid #ff6b6b;
    border-radius: 8px;
    box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.5),
                inset 0 0 0 1px rgba(255, 255, 255, 0.1);
    background: transparent;
    animation: pulse 1.5s infinite;
  }
  
  @keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.7), 
                  0 0 0 2px rgba(255, 255, 255, 0.5),
                  inset 0 0 0 1px rgba(255, 255, 255, 0.1); }
    70% { box-shadow: 0 0 0 10px rgba(255, 107, 107, 0), 
                   0 0 0 2px rgba(255, 255, 255, 0.5),
                   inset 0 0 0 1px rgba(255, 255, 255, 0.1); }
    100% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0), 
                   0 0 0 2px rgba(255, 255, 255, 0.5),
                   inset 0 0 0 1px rgba(255, 255, 255, 0.1); }
  }
  
  @keyframes cardPopIn {
    0% {
      transform: scale(0.5) translateZ(0) rotateX(90deg);
      opacity: 0;
    }
    70% {
      transform: scale(1.05) translateZ(0) rotateX(0);
      opacity: 1;
    }
    100% {
      transform: scale(1) translateZ(0) rotateX(0);
      opacity: 1;
    }
  }

    header {
      background-color: rgba(255, 182, 193, 0.7); /* æ¨±èŠ±è‰²åŠé€æ˜ */
      padding: 20px;
      border-radius: 15px;
      margin-bottom: 30px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }
    
    h1 {
      color: white;
      font-size: 2.5em;
      margin: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    h1 img {
            width: 32px;
            height: 32px;
            margin-right: 15px;
            vertical-align: middle;
            filter: drop-shadow(0 2px 2px rgba(0,0,0,0.3));
            transition: transform 0.3s ease;
        }
        
        h1 img:hover {
            transform: scale(1.1);
        }
    
    header p {
      color: white;
      margin: 10px 0 0 0;
      text-align: center;
      font-size: 1.1em;
    }

    .main-content {
      padding: 30px;
    }

    .upload-section {
      text-align: center;
      margin-bottom: 30px;
      padding: 30px;
      border: 3px dashed #a777e3;
      border-radius: 10px;
      background: #f9f7ff;
      transition: all 0.3s ease;
    }

    .upload-section:hover {
      background: #f0ebff;
      border-color: #5a4ae3;
    }

    .upload-label {
      display: block;
      padding: 20px;
      cursor: pointer;
      border-radius: 8px;
    }

    .upload-icon {
      font-size: 60px;
      color: #a777e3;
      margin-bottom: 15px;
    }

    .upload-text {
      font-size: 1.2rem;
      color: #5a4ae3;
      margin-bottom: 15px;
    }

    .file-input {
      display: none;
    }

    .upload-btn {
      background: #6e8efb;
      color: white;
      border: none;
      padding: 12px 30px;
      font-size: 1rem;
      border-radius: 50px;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 15px;
    }

    .upload-btn:hover {
      background: #5a4ae3;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(110, 142, 251, 0.4);
    }

    .options {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 20px;
      margin: 20px 0;
      flex-wrap: wrap;
    }

    .option-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .option-item label {
      font-weight: 500;
    }

    .option-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
    }

    /* éšè—å…¨å±€ä¿®æ­£é€‰é¡¹ */
     .option-item #useCorrection,
     .option-item label[for="useCorrection"] {
       display: none;
     }

    .selected-image-container {
      position: relative;
      display: inline-block;
      border: none;
      border-radius: 10px;
      padding: 20px;
      background-color: #f9f7ff;
      transition: all 0.3s ease;
    }
    
    .selected-image-container:hover {
      border-color: #8a2be2;
      background-color: #e6d7ff;
    }
    
    .selected-image {
      max-width: 100%;
      max-height: 300px;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      object-fit: contain;
    }
    
    .change-btn {
      margin-top: 15px;
      padding: 10px 20px;
      background-color: #8a2be2;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      transition: background-color 0.3s;
    }
    
    .change-btn:hover {
      background-color: #7a1bd2;
    }
    
    .preview-container {
      margin-top: 20px;
      text-align: center;
      opacity: 0;
      transform: translateY(20px);
      animation: fadeInUp 0.8s forwards 0.3s;
    }

    .preview-image {
      max-width: 100%;
      max-height: 300px;
      border-radius: 8px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      display: none;
      object-fit: contain;
    }

    .loading {
      display: none;
      text-align: center;
      margin: 20px 0;
      opacity: 1;
      transform: translateY(0);
      transition: opacity 0.5s ease, transform 0.5s ease;
    }

    .spinner {
      border: 5px solid #f3f3f3;
      border-top: 5px solid #6e8efb;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .result-section {
      display: none;
      margin-top: 30px;
    }

    .result-header {
      text-align: center;
      margin-bottom: 20px;
    }

    .result-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
    }

    .result-card {
      background: linear-gradient(145deg, #ffffff, #f0f0f0);
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 
        0 6px 16px rgba(0, 0, 0, 0.1),
        0 0 0 1px rgba(255, 255, 255, 0.1),
        inset 0 0 0 1px rgba(255, 255, 255, 0.3);
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      position: relative;
      z-index: 1;
      transform-style: preserve-3d;
      perspective: 1000px;
      cursor: pointer;
    }
    
    .result-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      border-radius: 15px;
      background: linear-gradient(120deg, 
        rgba(255, 255, 255, 0) 0%, 
        rgba(255, 255, 255, 0.4) 50%, 
        rgba(255, 255, 255, 0) 100%);
      z-index: -1;
      transition: all 0.3s ease;
      opacity: 0;
    }
    
    .result-card:hover::before {
      opacity: 1;
    }

    .result-card:hover {
      transform: translateY(-8px) scale(1.05);
      box-shadow: 
        0 20px 40px rgba(0, 0, 0, 0.2),
        0 0 0 1px rgba(255, 255, 255, 0.2),
        inset 0 0 0 1px rgba(255, 255, 255, 0.5);
    }
    
    .result-card:active {
      transform: translateY(-5px) scale(0.98);
    }
    
    .result-top {
      background: linear-gradient(90deg, #6e8efb, #a777e3);
      padding: 15px;
      text-align: center;
      position: relative;
      overflow: hidden;
    }
    
    .result-icon {
      font-size: 2rem;
      color: white;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      animation: float 3s ease-in-out infinite;
    }
    
    @keyframes float {
      0% { transform: translateY(0px); }
      50% { transform: translateY(-5px); }
      100% { transform: translateY(0px); }
    }

    .result-image {
      width: 100%;
      height: 200px;
      object-fit: cover;
    }

    .result-info {
      padding: 15px;
    }

    .result-name {
      font-size: 1.3rem;
      font-weight: bold;
      color: #5a4ae3;
      margin-bottom: 8px;
      transition: all 0.3s ease;
      display: inline-block;
      position: relative;
      cursor: pointer;
    }
    
    .result-name:hover {
      color: #ff6b6b;
      transform: translateY(-2px) scale(1.05);
      text-shadow: 0 2px 4px rgba(255, 107, 107, 0.3);
    }
    
    .result-name::after {
      content: '';
      position: absolute;
      width: 0;
      height: 2px;
      bottom: -2px;
      left: 0;
      background-color: #ff6b6b;
      transition: width 0.3s ease;
    }
    
    .result-name:hover::after {
      width: 100%;
    }

    .result-anime {
      font-size: 1rem;
      color: #666;
      margin-bottom: 8px;
      transition: all 0.3s ease;
      display: inline-block;
      position: relative;
      cursor: pointer;
    }
    
    .candidate-anime {
      font-size: 0.9rem;
      color: #777;
      margin: 5px 0;
      transition: all 0.3s ease;
      display: inline-block;
      position: relative;
      cursor: pointer;
    }
    
    .result-anime:hover,
    .candidate-anime:hover {
      color: #5a4ae3;
      transform: translateY(-2px) scale(1.05);
      text-shadow: 0 2px 4px rgba(90, 74, 227, 0.3);
    }
    
    .result-anime::after,
    .candidate-anime::after {
      content: '';
      position: absolute;
      width: 0;
      height: 2px;
      bottom: -2px;
      left: 0;
      background-color: #5a4ae3;
      transition: width 0.3s ease;
    }
    
    .result-anime:hover::after,
    .candidate-anime:hover::after {
      width: 100%;
    }

    .result-score {
      font-size: 0.9rem;
      color: #888;
      margin-bottom: 8px;
    }
    
    .confidence-bar-container {
      margin-bottom: 10px;
    }
    
    .confidence-bar {
      width: 100%;
      height: 8px;
      background-color: #e0e0e0;
      border-radius: 4px;
      overflow: hidden;
      position: relative;
    }
    
    .confidence-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #4CAF50, #8BC34A);
      border-radius: 4px;
      width: 0;
      transition: width 0.8s cubic-bezier(0.22, 0.61, 0.36, 1);
      position: relative;
      animation: fillBar 1s ease-out forwards;
    }
    
    .confidence-bar-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(
        45deg,
        rgba(255, 255, 255, 0.2) 25%,
        transparent 25%,
        transparent 50%,
        rgba(255, 255, 255, 0.2) 50%,
        rgba(255, 255, 255, 0.2) 75%,
        transparent 75%
      );
      background-size: 20px 20px;
      animation: progressAnimation 1s linear infinite;
      border-radius: 4px;
    }
    
    @keyframes fillBar {
      from {
        width: 0;
      }
      to {
        width: var(--confidence-percent);
      }
    }
    
    @keyframes progressAnimation {
      0% {
        background-position: 0 0;
      }
      100% {
        background-position: 20px 20px;
      }
    }

    .result-details {
      font-size: 0.9rem;
      color: #999;
    }
    
    .result-details-toggle {
      margin-top: 10px;
      text-align: center;
    }
    
    .toggle-btn {
      background: linear-gradient(90deg, #6e8efb, #a777e3);
      color: white;
      border: none;
      border-radius: 20px;
      padding: 5px 15px;
      cursor: pointer;
      font-size: 0.8rem;
      transition: all 0.3s ease;
    }
    
    .toggle-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    
    .result-details-hidden {
      margin-top: 10px;
      padding: 10px;
      background-color: #f8f9fa;
      border-radius: 8px;
      max-height: 0;
      opacity: 0;
      overflow: hidden;
      transition: max-height 0.5s ease, opacity 0.5s ease, padding 0.5s ease;
    }
    
    .result-details-hidden.expanded {
      max-height: 300px;
      opacity: 1;
      padding: 10px;
    }
    
    .candidate-results {
      margin-top: 10px;
    }
    
    .candidate-item {
      display: flex;
      justify-content: space-between;
      padding: 5px 0;
      border-bottom: 1px solid #eee;
    }
    
    .candidate-name {
      font-weight: bold;
      color: #5a4ae3;
    }
    
    .candidate-score {
      color: #666;
    }

    .error-message {
      display: none;
      background: #ffebee;
      color: #c62828;
      padding: 15px;
      border-radius: 8px;
      margin: 20px 0;
      text-align: center;
    }

    @media (max-width: 768px) {
      .main-content {
        padding: 20px;
      }
      
      header h1 {
        font-size: 1.8rem;
      }
      
      .result-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div id="background-container"></div>
  <div class="container">
    <header>
      <h1><img src="./images/icon.png" alt="åŠ¨æ¼«å›¾æ ‡" style="vertical-align: middle; margin-right: 10px; width: 32px; height: 32px;">åŠ¨æ¼«è§’è‰²è¯†åˆ«</h1>
      <p>ä¸Šä¼ å›¾ç‰‡ï¼Œè¯†åˆ«å…¶ä¸­çš„åŠ¨æ¼«è§’è‰²</p>
    </header>
    
    <!-- 3Då¡ç‰‡å¼¹å‡ºå±‚ -->
    <div id="popup-container" class="popup-container">
      <div class="card-3d">
        <img id="popupImage" src="" alt="Preview" class="popup-image">
        <div class="reflection"></div>
        <div class="highlight-overlay">
          <div class="moving-highlight"></div>
        </div>
      </div>
    </div>

    <div class="main-content">
      <div class="upload-section">
        <div id="uploadArea">
          <label class="upload-label" for="imageUpload">
            <div class="upload-icon">ğŸ“</div>
            <div class="upload-text">ç‚¹å‡»é€‰æ‹©å›¾ç‰‡æˆ–æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„</div>
            <p>æ”¯æŒ JPG, PNG, GIF æ ¼å¼ï¼Œæœ€å¤§æ”¯æŒ 5MB</p>
          </label>
          <input type="file" id="imageUpload" class="file-input" accept="image/*" onchange="previewImage(event)">
        </div>
        
        <div id="selectedImageArea" class="selected-image-container" style="display: none;" onclick="changeImage()">
            <img id="selectedImagePreview" class="selected-image" src="" alt="Selected Image">
            <div id="face-overlay" class="face-overlay"></div>
          </div>
        
        <div class="options">
          <div class="option-item">
            <input type="checkbox" id="useCorrection" checked style="display: none;">
            <label for="useCorrection" style="display: none;">å¯ç”¨å…¨å±€ä¿®æ­£</label>
          </div>
        </div>
      </div>
      
      <script>
         // æ›´æ¢å›¾ç‰‡åŠŸèƒ½ - ç‚¹å‡»å›¾ç‰‡æ›´æ¢
         function changeImage() {
           document.getElementById('selectedImageArea').style.display = 'none';
           document.getElementById('uploadArea').style.display = 'block';
           // æ¸…ç©ºæ–‡ä»¶è¾“å…¥æ¡†
           document.getElementById('imageUpload').value = '';
         }
       </script>

      <div class="preview-container">
        <img id="previewImage" class="preview-image" alt="å›¾ç‰‡é¢„è§ˆ">
      </div>

      <div class="loading" id="loading">
        <div class="spinner"></div>
        <p>æ­£åœ¨è¯†åˆ«ä¸­ï¼Œè¯·ç¨å€™...</p>
      </div>

      <div class="error-message" id="errorMessage"></div>

      <div class="result-section" id="resultSection">
        <div class="result-header">
          <h2>è¯†åˆ«ç»“æœ</h2>
        </div>
        <div class="result-grid" id="resultGrid"></div>
      </div>
    </div>
  </div>

  <script>
    // èƒŒæ™¯è½®æ’­åŠŸèƒ½
  const backgroundImages = [
    './images/background1.jpg',
    './images/background2.jpg',
    './images/background3.jpg',
    './images/background4.jpg',
    './images/background5.jpg',
    './images/background6.jpg',
    './images/background7.jpg',
    './images/background8.jpg',
    './images/background9.jpg'
  ];
  let currentBackgroundIndex = 0;

  function loadBackgroundImage(index) {
    const img = new Image();
    img.onload = function() {
      document.getElementById('background-container').style.backgroundImage = `url(${this.src})`;
      document.getElementById('background-container').style.opacity = '1';
    };
    img.onerror = function() {
      console.error(`Failed to load background image: ${this.src}`);
    };
    img.src = backgroundImages[index];
  }

  function changeBackground() {
    document.getElementById('background-container').style.opacity = '0';
    setTimeout(() => {
      // éšæœºé€‰æ‹©ä¸‹ä¸€å¼ å›¾ç‰‡ï¼Œç¡®ä¿ä¸ä¸å½“å‰å›¾ç‰‡é‡å¤
      let newBackgroundIndex;
      do {
        newBackgroundIndex = Math.floor(Math.random() * backgroundImages.length);
      } while (newBackgroundIndex === currentBackgroundIndex && backgroundImages.length > 1);
      
      currentBackgroundIndex = newBackgroundIndex;
      loadBackgroundImage(currentBackgroundIndex);
    }, 500); // ç­‰å¾…0.5ç§’ä»¥å®Œæˆæ·¡å‡ºæ•ˆæœ
  }

  // æ¯10ç§’åˆ‡æ¢ä¸€æ¬¡èƒŒæ™¯
  setInterval(changeBackground, 10000);

  // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºéšæœºèƒŒæ™¯
  window.onload = function() {
    currentBackgroundIndex = Math.floor(Math.random() * backgroundImages.length);
    loadBackgroundImage(currentBackgroundIndex);
  };

    document.addEventListener('DOMContentLoaded', function() {
      const imageUpload = document.getElementById('imageUpload');
      const previewImage = document.getElementById('previewImage');
      const loading = document.getElementById('loading');
      const errorMessage = document.getElementById('errorMessage');
      const resultSection = document.getElementById('resultSection');
      const resultGrid = document.getElementById('resultGrid');
      const useCorrection = document.getElementById('useCorrection');
      const uploadLabel = document.querySelector('.upload-label');

      // ä¿å­˜å½“å‰æ˜¾ç¤ºçš„å›¾ç‰‡
      let currentImageSrc = '';
      
      // ä¸Šä¼ å›¾ç‰‡å‡½æ•°
      function uploadImage() {
        // è·å–å½“å‰é€‰æ‹©çš„å›¾ç‰‡æ–‡ä»¶
        const imageUpload = document.getElementById('imageUpload');
        const file = imageUpload.files[0];
        const useCorrection = document.getElementById('useCorrection');
        
        if (file) {
          // æ£€æŸ¥æ–‡ä»¶å¤§å°
          if (file.size > 5 * 1024 * 1024) { // 5MB
            showError('æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡5MB');
            return;
          }

          // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
          showLoading();

          // å‡†å¤‡è¡¨å•æ•°æ®
          const formData = new FormData();
          formData.append('file', file);
          formData.append('use_correction', useCorrection.checked ? '1' : '0');

          // å‘é€è¯·æ±‚åˆ°åç«¯API
          fetch('/api/recognize', {
            method: 'POST',
            body: formData
          })
          .then(response => response.json())
          .then(data => {
            hideLoading();
            if (data.error) {
              showError(data.error);
            } else {
              displayResults(data);
            }
          })
          .catch(error => {
            hideLoading();
            showError('è¯†åˆ«å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            console.error('Error:', error);
          });
        } else {
          showError('è¯·å…ˆé€‰æ‹©ä¸€å¼ å›¾ç‰‡');
        }
      }
      
      // å›¾ç‰‡é¢„è§ˆåŠŸèƒ½ - ç°åœ¨æ”¹ä¸º3Då¡ç‰‡å¼¹å‡ºæ•ˆæœ
      imageUpload.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(event) {
            // ä¿å­˜å½“å‰å›¾ç‰‡è·¯å¾„
            currentImageSrc = event.target.result;
            
            const popupImage = document.getElementById('popupImage');
            const popupContainer = document.getElementById('popup-container');
            
            // è®¾ç½®å¼¹å‡ºå›¾ç‰‡çš„æº
            popupImage.src = event.target.result;
            
            // é‡ç½®åŠ¨ç”»ç±»
            const card3d = document.querySelector('.card-3d');
            card3d.classList.remove('active');
            
            // è§¦å‘é‡æ’
            void card3d.offsetWidth;
            
            // æ˜¾ç¤ºå¼¹å‡ºå±‚
             setTimeout(() => {
              popupContainer.classList.add('active');
              
              // è‡ªåŠ¨ä¸Šä¼ å›¾ç‰‡
              uploadImage();
            }, 10);
          }
          reader.readAsDataURL(file);
        }
      });

      // æ‹–æ‹½ä¸Šä¼ åŠŸèƒ½
      uploadLabel.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadLabel.style.backgroundColor = '#e6d7ff';
      });

      uploadLabel.addEventListener('dragleave', function(e) {
        e.preventDefault();
        uploadLabel.style.backgroundColor = '#f9f7ff';
      });

      uploadLabel.addEventListener('drop', function(e) {
        e.preventDefault();
        uploadLabel.style.backgroundColor = '#f9f7ff';
        const file = e.dataTransfer.files[0];
        if (file && file.type.startsWith('image/')) {
          imageUpload.files = e.dataTransfer.files;
          
          const reader = new FileReader();
          reader.onload = function(event) {
            // ä¿å­˜å½“å‰å›¾ç‰‡è·¯å¾„
            currentImageSrc = event.target.result;
            
            const popupImage = document.getElementById('popupImage');
            const popupContainer = document.getElementById('popup-container');
            
            // è®¾ç½®å¼¹å‡ºå›¾ç‰‡çš„æº
            popupImage.src = event.target.result;
            
            // é‡ç½®åŠ¨ç”»ç±»
            const card3d = document.querySelector('.card-3d');
            card3d.classList.remove('active');
            
            // è§¦å‘é‡æ’
            void card3d.offsetWidth;
            
            // æ˜¾ç¤ºå¼¹å‡ºå±‚
             setTimeout(() => {
              popupContainer.classList.add('active');
              
              // è‡ªåŠ¨ä¸Šä¼ å›¾ç‰‡
              uploadImage();
              
              // åœ¨è¯†åˆ«å®Œæˆåå°†å›¾ç‰‡æ˜¾ç¤ºåœ¨.selected-image-containerä¸­
              setTimeout(() => {
                document.getElementById('uploadArea').style.display = 'none';
                const selectedImageArea = document.getElementById('selectedImageArea');
                selectedImageArea.style.display = 'block';
                document.getElementById('selectedImagePreview').src = currentImageSrc;
              }, 1000); // ç­‰å¾…ä¸Šä¼ å’Œè¯†åˆ«å®Œæˆåå†æ˜¾ç¤º
            }, 10);
          }
          reader.readAsDataURL(file);
        }
      });



      // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
      function showLoading() {
        loading.style.display = 'block';
        // ç§»é™¤æ–‡æœ¬æç¤ºï¼Œåªä¿ç•™åŠ¨ç”»æ•ˆæœ
        const loadingText = document.querySelector('#loading p');
        if(loadingText) loadingText.textContent = '';
        errorMessage.style.display = 'none';
        resultSection.style.display = 'none';
      }

      // éšè—åŠ è½½çŠ¶æ€
      function hideLoading() {
        // æ·»åŠ æ·¡å‡ºåŠ¨ç”»æ•ˆæœ
        const loadingElement = document.getElementById('loading');
        loadingElement.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
        loadingElement.style.opacity = '0';
        loadingElement.style.transform = 'translateY(-10px)';
        
        // ç­‰å¾…åŠ¨ç”»å®Œæˆåå®Œå…¨éšè—
        setTimeout(() => {
          loadingElement.style.display = 'none';
          loadingElement.style.opacity = '1';
          loadingElement.style.transform = 'translateY(0)';
        }, 500);
      }

      // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
      function showError(message) {
        errorMessage.textContent = message;
        errorMessage.style.display = 'block';
      }

      // æ˜¾ç¤ºè¯†åˆ«ç»“æœ
      function displayResults(data) {
        console.log('APIè¿”å›çš„æ•°æ®:', data); // è°ƒè¯•ä¿¡æ¯
        
        resultGrid.innerHTML = '';
        
        if (data.faces && data.faces.length > 0) {
          // ä¿å­˜å®Œæ•´çš„äººè„¸æ•°æ®ç”¨äºåç»­æ˜¾ç¤º
          window.faceData = data.faces;
          
          data.faces.forEach((face, index) => {
            console.log(`äººè„¸ ${index} çš„æ•°æ®:`, face); // è°ƒè¯•ä¿¡æ¯
            
            const card = document.createElement('div');
            card.className = 'result-card';
            // åˆå§‹è®¾ç½®å¡ç‰‡ä¸ºä¸å¯è§çŠ¶æ€
            card.style.opacity = '0';
            card.style.transform = 'translateY(20px)';
            card.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
            
            // å­˜å‚¨äººè„¸ç´¢å¼•åˆ°å¡ç‰‡ä¸Šï¼Œä»¥ä¾¿è®¿é—®å®Œæ•´æ•°æ®
            card.dataset.faceIndex = index;
            
            // åˆ›å»ºç»“æœå¡ç‰‡çš„HTML
            card.innerHTML = `
              <div class="result-top">
                <div class="result-icon">ğŸ˜º</div>
              </div>
              <div class="result-info">
                <div class="result-name" onclick="searchCharacter('${face.name || 'æœªçŸ¥è§’è‰²'}', '${face.anime || 'æœªçŸ¥'}')">${face.name || 'æœªçŸ¥è§’è‰²'}</div>
                <div class="result-anime" onclick="searchAnime('${face.anime || 'æœªçŸ¥'}')">ä½œå“: ${face.anime || 'æœªçŸ¥'}</div>
                <div class="result-score">ç½®ä¿¡åº¦: ${(face.score * 100).toFixed(2)}%</div>
                <div class="confidence-bar-container">
                  <div class="confidence-bar">
                    <div class="confidence-bar-fill" style="--confidence-percent: ${(face.score * 100).toFixed(2)}%"></div>
                  </div>
                </div>
                <div class="result-details-toggle">
                  <button class="toggle-btn">å±•å¼€è¯¦æƒ…</button>
                </div>
                <div class="result-details-hidden">
                  å€™é€‰ç»“æœ:
                  <div class="candidate-results">
                    ${(face.top_k && face.top_k.length > 0) ? face.top_k.map((candidate, idx) => 
                      `<div class="candidate-item">
                        <span class="candidate-name" onclick="searchCharacter('${candidate.name || 'æœªçŸ¥è§’è‰²'}', '${candidate.anime || 'æœªçŸ¥'}')">${candidate.name}</span>
                        <span class="candidate-anime" onclick="searchAnime('${candidate.anime || 'æœªçŸ¥'}')">ä½œå“: ${candidate.anime || 'æœªçŸ¥'}</span>
                        <span class="candidate-score">ç½®ä¿¡åº¦: ${(candidate.score * 100).toFixed(2)}%</span>
                      </div>`).join('') : 'æ— å€™é€‰ç»“æœ'}
                  </div>
                </div>
              </div>
            `;
            
            // æ·»åŠ é¼ æ ‡è¿›å…¥äº‹ä»¶ - ç»“åˆæ˜¾ç¤ºäººè„¸æ¡†é€‰å’Œ3Dæ•ˆæœ
            card.addEventListener('mouseenter', function() {
              // æ˜¾ç¤º3Då¼¹å‡ºå›¾ç‰‡å¹¶é«˜äº®å¯¹åº”äººç‰©
              const faceIndex = parseInt(this.dataset.faceIndex);
              showPopupWithFaceHighlight(window.faceData[faceIndex]);
              this.style.transition = 'none'; // ç§»é™¤è¿‡æ¸¡æ•ˆæœä»¥è·å¾—æ›´æµç•…çš„é¼ æ ‡è·Ÿéš
            });
            
            // æ·»åŠ é¼ æ ‡ç§»åŠ¨äº‹ä»¶å®ç°3Dæ•ˆæœ
            card.addEventListener('mousemove', function(e) {
              const cardRect = this.getBoundingClientRect();
              const x = e.clientX - cardRect.left;
              const y = e.clientY - cardRect.top;
              
              const centerX = cardRect.width / 2;
              const centerY = cardRect.height / 2;
              
              const rotateY = (x - centerX) / 25; // æ§åˆ¶æ°´å¹³æ—‹è½¬
              const rotateX = (centerY - y) / 25; // æ§åˆ¶å‚ç›´æ—‹è½¬
              const scale = 1.05; // åŸºç¡€ç¼©æ”¾
                
              this.style.transform = `perspective(1000px) rotateX(${rotateX}deg) rotateY(${rotateY}deg) scale(${scale})`;
            });
            
            // æ·»åŠ é¼ æ ‡ç¦»å¼€äº‹ä»¶
            card.addEventListener('mouseleave', function() {
              this.style.transition = 'all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)'; // æ¢å¤è¿‡æ¸¡æ•ˆæœ
              this.style.transform = 'translateY(-8px) scale(1)';
              removeFaceHighlight(); // ç§»é™¤äººè„¸æ¡†é€‰
            });
            
            // æ·»åŠ å±•å¼€/æŠ˜å åŠŸèƒ½
            const toggleBtn = card.querySelector('.toggle-btn');
            const detailsHidden = card.querySelector('.result-details-hidden');
            
            if (toggleBtn && detailsHidden) {
              toggleBtn.addEventListener('click', function() {
                if (detailsHidden.classList.contains('expanded')) {
                  // æ”¶èµ·è¯¦æƒ…
                  detailsHidden.classList.remove('expanded');
                  toggleBtn.textContent = 'å±•å¼€è¯¦æƒ…';
                } else {
                  // å±•å¼€è¯¦æƒ…
                  detailsHidden.classList.add('expanded');
                  toggleBtn.textContent = 'æ”¶èµ·è¯¦æƒ…';
                }
              });
            }
            
            resultGrid.appendChild(card);
          });
          
          // æ˜¾ç¤ºç»“æœåŒºåŸŸ
          resultSection.style.display = 'block';
          resultSection.style.opacity = '0';
          resultSection.style.transform = 'translateY(20px)';
          
          // å¼ºåˆ¶é‡æ’ä»¥ç¡®ä¿åŠ¨ç”»æ•ˆæœ
          resultSection.offsetHeight;
          
          // æ·»åŠ æ·¡å…¥åŠ¨ç”»
          setTimeout(() => {
            resultSection.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
            resultSection.style.opacity = '1';
            resultSection.style.transform = 'translateY(0)';
            
            // ä¸ºæ¯ä¸ªå¡ç‰‡æ·»åŠ è¿›å…¥åŠ¨ç”»
            const cards = resultGrid.querySelectorAll('.result-card');
            cards.forEach((card, index) => {
              setTimeout(() => {
                card.style.opacity = '1';
                card.style.transform = 'translateY(0)';
              }, 100 * index); // ä¾æ¬¡å»¶è¿Ÿæ˜¾ç¤ºæ¯ä¸ªå¡ç‰‡
            });
          }, 50);
          
        } else {
          errorMessage.textContent = 'æœªè¯†åˆ«åˆ°ä»»ä½•åŠ¨æ¼«è§’è‰²';
          errorMessage.style.display = 'block';
          errorMessage.style.opacity = '0';
          errorMessage.style.transform = 'translateY(20px)';
          errorMessage.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
          
          // å¼ºåˆ¶é‡æ’ä»¥ç¡®ä¿åŠ¨ç”»æ•ˆæœ
          errorMessage.offsetHeight;
          
          // æ·»åŠ æ·¡å…¥åŠ¨ç”»
          setTimeout(() => {
            errorMessage.style.opacity = '1';
            errorMessage.style.transform = 'translateY(0)';
          }, 50);
        }
      }
    });
    
    // ç‚¹å‡»å¼¹å‡ºå±‚èƒŒæ™¯å…³é—­å¼¹å‡º
    document.getElementById('popup-container').addEventListener('click', function(e) {
      if (e.target === this) {
        this.classList.remove('active');
        
        // å°†é€‰æ‹©å›¾ç‰‡çš„åŒºåŸŸæ›¿æ¢ä¸ºå·²é€‰æ‹©çš„å›¾ç‰‡
        if (currentImageSrc) {
          document.getElementById('uploadArea').style.display = 'none';
          const selectedImageArea = document.getElementById('selectedImageArea');
          selectedImageArea.style.display = 'block';
          document.getElementById('selectedImagePreview').src = currentImageSrc;
        }
      }
    });
    
    // æ·»åŠ é¼ æ ‡ç§»åŠ¨äº‹ä»¶ç›‘å¬å™¨ï¼ŒåŒæ—¶å®ç°3Då¡ç‰‡è·Ÿéšé¼ æ ‡å˜æ¢æ•ˆæœå’Œé«˜å…‰æ•ˆæœ
    const card3d = document.querySelector('.card-3d');
    const movingHighlight = document.querySelector('.moving-highlight');
    
    if (card3d) {
      // ä¿å­˜åŸå§‹åŠ¨ç”»çŠ¶æ€
      let isAnimating = true;
      
      // ç›‘å¬åŠ¨ç”»ç»“æŸäº‹ä»¶
      card3d.addEventListener('animationend', () => {
        isAnimating = false; // åŠ¨ç”»ç»“æŸåå¯ç”¨é¼ æ ‡äº¤äº’
      });
      
      card3d.addEventListener('mousemove', (e) => {
        if (isAnimating) return; // å¦‚æœè¿˜åœ¨æ‰§è¡Œåˆå§‹åŠ¨ç”»ï¼Œåˆ™ä¸å¤„ç†é¼ æ ‡ç§»åŠ¨äº‹ä»¶
        
        const card = e.currentTarget;
        const rect = card.getBoundingClientRect();
        
        // è®¡ç®—é¼ æ ‡åœ¨å¡ç‰‡ä¸Šçš„ç›¸å¯¹ä½ç½® (0-1)
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        
        // è®¡ç®—ä¸­å¿ƒç‚¹
        const centerX = rect.width / 2;
        const centerY = rect.height / 2;
        
        // è®¡ç®—åç§»é‡ (-1 åˆ° 1)
        const moveX = (x - centerX) / centerX;
        const moveY = (y - centerY) / centerY;
        
        // åº”ç”¨3Då˜æ¢
        card.style.transform = `perspective(1500px) rotateY(${moveX * 10}deg) rotateX(${moveY * -10}deg) translateZ(30px)`;
        
        // æ›´æ–°é«˜å…‰ä½ç½®
        if (movingHighlight) {
          const highlightX = ((e.clientX - rect.left) / rect.width) * 100;
          const highlightY = ((e.clientY - rect.top) / rect.height) * 100;
          
          movingHighlight.style.setProperty('--mouse-x', highlightX + '%');
          movingHighlight.style.setProperty('--mouse-y', highlightY + '%');
        }
      });
      
      // é¼ æ ‡ç¦»å¼€æ—¶æ¢å¤åŸå§‹çŠ¶æ€ï¼Œæ·»åŠ åŠ¨ç”»æ•ˆæœ
      card3d.addEventListener('mouseleave', (e) => {
        if (!isAnimating) {
          // ä½¿ç”¨æ›´å¹³æ»‘çš„è¿‡æ¸¡åŠ¨ç”»
          e.currentTarget.style.transition = 'transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
          e.currentTarget.style.transform = `perspective(1500px) rotateY(0) rotateX(0) translateZ(0)`;
          
          // åœ¨åŠ¨ç”»ç»“æŸåæ¢å¤é»˜è®¤è¿‡æ¸¡è®¾ç½®
          setTimeout(() => {
            e.currentTarget.style.transition = 'transform 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
          }, 400);
        }
        
        // éšè—é«˜å…‰
        if (movingHighlight) {
          movingHighlight.style.opacity = '0';
        }
      });
      
      // é¼ æ ‡è¿›å…¥æ—¶æ˜¾ç¤ºé«˜å…‰
      card3d.addEventListener('mouseenter', (e) => {
        if (movingHighlight) {
          movingHighlight.style.opacity = '0.6';
        }
      });
    }
    
    // æ·»åŠ ESCé”®å…³é—­å¼¹å‡ºå±‚çš„åŠŸèƒ½
  document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        document.getElementById('popup-container').classList.remove('active');
        
        // å°†é€‰æ‹©å›¾ç‰‡çš„åŒºåŸŸæ›¿æ¢ä¸ºå·²é€‰æ‹©çš„å›¾ç‰‡
        if (currentImageSrc) {
          document.getElementById('uploadArea').style.display = 'none';
          const selectedImageArea = document.getElementById('selectedImageArea');
          selectedImageArea.style.display = 'block';
          document.getElementById('selectedImagePreview').src = currentImageSrc;
        }
      }
    });
    
    /**
     * ç§»é™¤é«˜äº®æ˜¾ç¤º
     * 
     * @returns {void}
     * 
     * @description
     * è¯¥å‡½æ•°ç§»é™¤å½“å‰çš„é«˜äº®æ˜¾ç¤ºæ•ˆæœ
     */
    function removeFaceHighlight() {
      // ç§»é™¤é«˜äº®æ¡†
      const highlightBox = document.getElementById('face-highlight-box');
      if (highlightBox) {
        highlightBox.remove();
      }
    }
    
    /**
     * åœ¨åŸå›¾ä¸Šé«˜äº®æ˜¾ç¤ºäººè„¸ä½ç½®ï¼Œä½¿ç”¨é€æ¸é€¼è¿‘çš„æ–¹æ¡†æ•ˆæœ
     * 
     * @param {Object} faceData - äººè„¸æ•°æ®å¯¹è±¡
     * @returns {void}
     * 
     * @description
     * è¯¥å‡½æ•°åœ¨åŸå›¾ä¸Šç»˜åˆ¶ä¸€ä¸ªé€æ¸é€¼è¿‘çš„æ–¹æ¡†æ¥é«˜äº®æ˜¾ç¤ºäººè„¸ä½ç½®
     * 
     * @throws {Error} å½“å‚æ•°æ— æ•ˆæ—¶å¯èƒ½æŠ›å‡ºé”™è¯¯
     */
    function showPopupWithFaceHighlight(faceData) {
      if (!faceData) return;
      
      try {
        // ä»äººè„¸æ•°æ®ä¸­è·å–è¾¹ç•Œæ¡†ä¿¡æ¯
        let bbox = null;
        if (faceData.bounding_box) {
          bbox = faceData.bounding_box;  // ä½¿ç”¨APIè¿”å›çš„æƒå¨äººè„¸æ¡†åæ ‡
        } else if (faceData.bbox) {
          bbox = faceData.bbox;
        } else if (faceData.location) {
          bbox = faceData.location;
        } else if (faceData.box) {
          bbox = faceData.box;
        } else if (faceData.rect) {
          bbox = faceData.rect;
        } else {
          // å°è¯•æŸ¥æ‰¾åŒ…å«åæ ‡ä¿¡æ¯çš„å­—æ®µ
          const possibleFields = Object.keys(faceData).filter(key => 
            key.toLowerCase().includes('box') || 
            key.toLowerCase().includes('rect') || 
            key.toLowerCase().includes('location')
          );
          
          if (possibleFields.length > 0) {
            bbox = faceData[possibleFields[0]];
          }
        }
        
        if (!bbox) {
          console.warn('æœªæ‰¾åˆ°äººè„¸è¾¹ç•Œæ¡†ä¿¡æ¯');
          return;
        }
        
        // è®¡ç®—è¾¹ç•Œæ¡†åæ ‡
        let x, y, width, height;
        
        if (Array.isArray(bbox)) {
          if (bbox.length === 4) {
            // å¤„ç† [x1, y1, x2, y2] æ ¼å¼ - APIè¿”å›çš„æƒå¨äººè„¸æ¡†åæ ‡
            const [x1, y1, x2, y2] = bbox;
            x = x1;
            y = y1;
            width = x2 - x1;
            height = y2 - y1;
          } else {
            console.warn('è¾¹ç•Œæ¡†æ•°ç»„æ ¼å¼ä¸æ­£ç¡®');
            return;
          }
        } else if (typeof bbox === 'object') {
          if (bbox.x !== undefined && bbox.y !== undefined && 
              bbox.width !== undefined && bbox.height !== undefined) {
            x = bbox.x;
            y = bbox.y;
            width = bbox.width;
            height = bbox.height;
          } 
          // æˆ–è€… {left, top, right, bottom} æ ¼å¼
          else if (bbox.left !== undefined && bbox.top !== undefined && 
                   bbox.right !== undefined && bbox.bottom !== undefined) {
            x = bbox.left;
            y = bbox.top;
            width = bbox.right - bbox.left;
            height = bbox.bottom - bbox.top;
          } else {
            console.warn('è¾¹ç•Œæ¡†å¯¹è±¡æ ¼å¼ä¸æ­£ç¡®');
            return;
          }
        } else {
          console.warn('è¾¹ç•Œæ¡†æ•°æ®æ ¼å¼ä¸æ”¯æŒ');
          return;
        }
        
        // è·å–åŸå›¾å…ƒç´ å’Œoverlayå…ƒç´ 
        const originalImage = document.querySelector('.selected-image');
        if (!originalImage) {
          console.warn('æœªæ‰¾åˆ°åŸå›¾å…ƒç´ ');
          return;
        }
        
        // è·å–å›¾ç‰‡å®¹å™¨å…ƒç´ 
        const imageContainer = document.querySelector('.selected-image-container');
        if (!imageContainer) {
          console.warn('æœªæ‰¾åˆ°å›¾ç‰‡å®¹å™¨å…ƒç´ ');
          return;
        }
        
        // è·å–face-overlayå…ƒç´ 
        const faceOverlay = document.getElementById('face-overlay');
        if (!faceOverlay) {
          console.warn('æœªæ‰¾åˆ°face-overlayå…ƒç´ ');
          return;
        }
        
        // æ¸…é™¤ä¹‹å‰å¯èƒ½å­˜åœ¨çš„æ¡†
        faceOverlay.innerHTML = '';
        
        // ç”Ÿæˆéšæœºé¢œè‰²
        const randomColor = '#' + Math.floor(Math.random()*16777215).toString(16).padStart(6, '0');
        
        // åˆ›å»ºä¸€ä¸ªdivå…ƒç´ ä½œä¸ºé«˜äº®æ¡†
        const highlightBox = document.createElement('div');
        highlightBox.id = 'face-highlight-box';
        highlightBox.style.position = 'absolute';
        highlightBox.style.border = '2px solid ' + randomColor;
        highlightBox.style.backgroundColor = 'transparent';
        highlightBox.style.pointerEvents = 'none';
        highlightBox.style.zIndex = '100';
        highlightBox.style.opacity = '0.8';
        highlightBox.style.boxShadow = `0 0 10px ${randomColor}aa`; // æ·»åŠ é€æ˜åº¦
        
        // è®¡ç®—ç›¸å¯¹äºå›¾ç‰‡å®¹å™¨çš„åæ ‡
        const containerRect = imageContainer.getBoundingClientRect();
        const imageRect = originalImage.getBoundingClientRect();
        
        // åˆå§‹ä½ç½®è®¾ä¸ºå›¾ç‰‡ä¸­å¿ƒï¼Œç„¶åé€æ¸ç§»åŠ¨åˆ°ç›®æ ‡ä½ç½®
        // ä»å›¾ç‰‡å…ƒç´ çš„ä¸­å¿ƒå¼€å§‹ï¼Œè€Œä¸æ˜¯å®¹å™¨çš„ä¸­å¿ƒ
        const centerX = (imageRect.left - containerRect.left) + imageRect.width / 2;
        const centerY = (imageRect.top - containerRect.top) + imageRect.height / 2;
        const centerWidth = 20;
        const centerHeight = 20;
        
        // è®¾ç½®åˆå§‹ä½ç½®å’Œå°ºå¯¸
        highlightBox.style.left = `${centerX - centerWidth / 2}px`;
        highlightBox.style.top = `${centerY - centerHeight / 2}px`;
        highlightBox.style.width = `${centerWidth}px`;
        highlightBox.style.height = `${centerHeight}px`;
        
        // æ·»åŠ åˆ°overlay
        faceOverlay.appendChild(highlightBox);
        
        // ä½¿ç”¨requestAnimationFrameå®ç°é€æ¸é€¼è¿‘çš„æ•ˆæœ
        const startTime = performance.now();
        const duration = 500; // åŠ¨ç”»æŒç»­æ—¶é—´500ms
        
        // è®¡ç®—å›¾ç‰‡çš„ç¼©æ”¾æ¯”ä¾‹å’Œåç§»
        const naturalWidth = originalImage.naturalWidth || originalImage.width;
        const naturalHeight = originalImage.naturalHeight || originalImage.height;
        const displayWidth = originalImage.clientWidth;
        const displayHeight = originalImage.clientHeight;
        
        // æ ¹æ®object-fit: containè®¡ç®—å®é™…æ˜¾ç¤ºçš„å›¾ç‰‡å°ºå¯¸å’Œåç§»
        const scale = Math.min(displayWidth / naturalWidth, displayHeight / naturalHeight);
        const actualWidth = naturalWidth * scale;
        const actualHeight = naturalHeight * scale;
        const offsetX = (displayWidth - actualWidth) / 2;
        const offsetY = (displayHeight - actualHeight) / 2;
        
        // åŠ¨ç”»å‡½æ•°
        function animateBox(timestamp) {
          const elapsed = timestamp - startTime;
          const progress = Math.min(elapsed / duration, 1);
          
          // ä½¿ç”¨ç¼“åŠ¨å‡½æ•°ä½¿åŠ¨ç”»æ›´è‡ªç„¶
          const easeProgress = 1 - Math.pow(1 - progress, 3);
          
          // è®¡ç®—å½“å‰çš„ä½ç½®å’Œå°ºå¯¸
          // å°†åŸå§‹åæ ‡è½¬æ¢ä¸ºåœ¨å®é™…æ˜¾ç¤ºå›¾ç‰‡ä¸Šçš„åæ ‡
          const scaledX = x * scale + offsetX;
          const scaledY = y * scale + offsetY;
          const scaledWidth = width * scale;
          const scaledHeight = height * scale;
          
          // è®¡ç®—ä»ä¸­å¿ƒç‚¹é€æ¸ç§»åŠ¨åˆ°ç›®æ ‡ä½ç½®çš„åæ ‡
          // éœ€è¦è€ƒè™‘å›¾ç‰‡åœ¨å®¹å™¨ä¸­çš„å®é™…ä½ç½®
          const imageRect = originalImage.getBoundingClientRect();
          const containerRect = imageContainer.getBoundingClientRect();
          
          // å°†å›¾ç‰‡ä¸Šçš„åæ ‡è½¬æ¢ä¸ºç›¸å¯¹äºå®¹å™¨çš„åæ ‡
          const targetX = (imageRect.left - containerRect.left) + scaledX;
          const targetY = (imageRect.top - containerRect.top) + scaledY;
          
          const currentX = centerX + (targetX - centerX) * easeProgress;
          const currentY = centerY + (targetY - centerY) * easeProgress;
          const currentWidth = centerWidth + (scaledWidth - centerWidth) * easeProgress;
          const currentHeight = centerHeight + (scaledHeight - centerHeight) * easeProgress;
          
          // æ›´æ–°æ ·å¼
          highlightBox.style.left = `${currentX}px`;
          highlightBox.style.top = `${currentY}px`;
          highlightBox.style.width = `${currentWidth}px`;
          highlightBox.style.height = `${currentHeight}px`;
          
          if (progress < 1) {
            requestAnimationFrame(animateBox);
          }
        }
        
        // å¼€å§‹åŠ¨ç”»
        requestAnimationFrame(animateBox);
        
      } catch (error) {
        console.error('é«˜äº®æ˜¾ç¤ºäººè„¸æ—¶å‡ºé”™:', error);
      }
    }
    
  // ä¿å­˜å½“å‰æ˜¾ç¤ºçš„å›¾ç‰‡
  let currentImageSrc = '';
  
  /**
   * æœç´¢åŠ¨æ¼«ä½œå“
   * 
   * @param {string} animeName - è¦æœç´¢çš„åŠ¨æ¼«ä½œå“åç§°
   * @returns {void}
   * 
   * @description
   * è¯¥å‡½æ•°åœ¨æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€æœç´¢ç»“æœé¡µé¢ï¼Œä½¿ç”¨ç™¾åº¦æœç´¢åŠ¨æ¼«ä½œå“
   */
  function searchAnime(animeName) {
    if (animeName && animeName !== 'æœªçŸ¥') {
      // ä½¿ç”¨ç™¾åº¦æœç´¢åŠ¨æ¼«ä½œå“
      const searchUrl = `https://www.baidu.com/s?wd=${encodeURIComponent(animeName + ' åŠ¨æ¼«')}`;
      window.open(searchUrl, '_blank');
    } else {
      alert('ä½œå“åç§°æœªçŸ¥ï¼Œæ— æ³•æœç´¢');
    }
  }
  
  /**
   * æœç´¢åŠ¨æ¼«è§’è‰²
   * 
   * @param {string} characterName - è¦æœç´¢çš„åŠ¨æ¼«è§’è‰²åç§°
   * @param {string} animeName - è§’è‰²æ‰€å±çš„åŠ¨æ¼«ä½œå“åç§°
   * @returns {void}
   * 
   * @description
   * è¯¥å‡½æ•°åœ¨æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€æœç´¢ç»“æœé¡µé¢ï¼Œä½¿ç”¨ç™¾åº¦æœç´¢åŠ¨æ¼«è§’è‰²åŠå…¶æ‰€å±ä½œå“
   */
  function searchCharacter(characterName, animeName) {
    if (characterName && characterName !== 'æœªçŸ¥è§’è‰²') {
      if (animeName && animeName !== 'æœªçŸ¥') {
        // åŒæ—¶æœç´¢è§’è‰²å’Œä½œå“
        const searchUrl = `https://www.baidu.com/s?wd=${encodeURIComponent(characterName + ' ' + animeName + ' åŠ¨æ¼«è§’è‰²')}`;
        window.open(searchUrl, '_blank');
      } else {
        // åªæœç´¢è§’è‰²
        const searchUrl = `https://www.baidu.com/s?wd=${encodeURIComponent(characterName + ' åŠ¨æ¼«è§’è‰²')}`;
        window.open(searchUrl, '_blank');
      }
    } else {
      alert('è§’è‰²åç§°æœªçŸ¥ï¼Œæ— æ³•æœç´¢');
    }
  }
  
  // ä¿®æ”¹previewImageå‡½æ•°ä»¥ä¿å­˜å½“å‰å›¾ç‰‡
  function previewImage(event) {
    const file = event.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        // ä¿å­˜å½“å‰å›¾ç‰‡è·¯å¾„
        currentImageSrc = e.target.result;
        
        // æ˜¾ç¤º3Då¡ç‰‡å¼¹å‡ºå±‚
        const popupContainer = document.getElementById('popup-container');
        const popupImage = document.getElementById('popupImage');
        
        popupImage.src = e.target.result;
        
        // é‡ç½®åŠ¨ç”»ç±»
        const card3d = document.querySelector('.card-3d');
        card3d.classList.remove('active');
        
        // è§¦å‘é‡æ’
        void card3d.offsetWidth;
        
        // æ˜¾ç¤ºå¼¹å‡ºå±‚
        setTimeout(() => {
          popupContainer.classList.add('active');
        }, 10);
      };
      reader.readAsDataURL(file);
    }
  }
  </script>
</body>
</html>